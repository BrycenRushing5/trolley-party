<!DOCTYPE html>
<html>
<head>
  <title>Trolley Party</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/papercss@1.9.2/dist/paper.min.css">

  <style>
    /* --- NO SCROLL LAYOUT --- */
    body, html {
        height: 100%;
        margin: 0;
        overflow: hidden; /* Kill the scroll */
        background-color: #f0f0f0;
        font-family: 'Patrick Hand', cursive;
    }

    .container {
        display: flex;
        flex-direction: column;
        height: 100dvh; /* Dynamic viewport height */
        max-width: 100%;
        padding: 1rem;
        box-sizing: border-box;
    }

    .main-content {
        flex: 1; /* Take up remaining space */
        display: flex;
        flex-direction: column;
        justify-content: center; /* Center vertically */
        align-items: center;
        width: 100%;
        overflow-y: auto; /* Allow inner content scroll if absolutely needed */
    }

    /* --- CUSTOM COMPONENTS --- */
    .screen { display: none; width: 100%; height: 100%; }
    .active { display: flex; flex-direction: column; }

    .btn-pull { background-color: #ff4757 !important; color: white !important; }
    .btn-wait { background-color: #2ed573 !important; color: white !important; }
    
    /* Toggle Switch Look for Host Settings */
    .settings-panel {
        border: 2px dashed #333;
        padding: 20px;
        margin-bottom: 20px;
        background: white;
    }

    select {
        font-family: 'Patrick Hand', cursive;
        font-size: 1.2rem;
        padding: 10px;
        width: 100%;
    }

    /* Big Text for TV */
    #question-text { font-size: 4vh; line-height: 1.2; margin-bottom: 20px;}
    .vote-count { font-size: 8vh; font-weight: bold; }
    
    /* Mobile Buttons */
    .mobile-btn-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 100%;
        height: 60%;
    }
    .big-action-btn {
        flex: 1;
        font-size: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 3px solid black;
    }
  </style>
</head>
<body>
  <div class="container">

    <div id="view-login" class="screen active main-content">
      <h1>Absurd Trolley</h1>
      <input type="text" id="username" placeholder="Enter Name" style="text-align:center; font-size: 1.5rem; margin-bottom: 20px;">
      <button class="btn btn-primary" onclick="joinGame()">Join Party</button>
      <div style="margin-top: 50px; opacity: 0.6;">
          <button class="btn btn-small" onclick="becomeHost()">Host (TV)</button>
      </div>
    </div>

    <div id="view-host" class="screen">
      
      <div id="host-lobby" class="main-content">
        <h2>Join the Party!</h2>
        <img id="qr-code-img" src="" style="height: 20vh; border: 3px dashed #333;">
        
        <div class="row" style="width: 100%; margin-top: 20px;">
            <div class="col-6">
                <h3>Players:</h3>
                <ul id="player-list" style="max-height: 30vh; overflow-y: auto;"></ul>
            </div>
            <div class="col-6">
                <div class="settings-panel">
                    <label>Vibe:</label>
                    <select id="setting-vibe" onchange="updateSettings()">
                        <option value="all">Everything</option>
                        <option value="philosophy">Philosophy Class</option>
                        <option value="party">Drunk Party</option>
                        <option value="dark">Dark Mode</option>
                    </select>
                    <br><br>
                    <label>Game Mode:</label>
                    <select id="setting-mode" onchange="updateSettings()">
                        <option value="standard">Standard Voting</option>
                        <option value="debate">Debate & Sway</option>
                        <option value="identity">Identity Guess</option>
                        <option value="devil">Devil's Advocate</option>
                    </select>
                </div>
                <button class="btn btn-success btn-large" onclick="socket.emit('startGame')">Start Game</button>
            </div>
        </div>
      </div>

      <div id="host-game" class="main-content" style="display:none;">
        <h1 id="question-text">Loading...</h1>
        
        <div class="row" style="width: 100%;">
          <div class="col-6" style="border-right: 2px dashed #ccc;">
              <h2 style="color: #ff4757;">PULL LEVER</h2>
              <div id="score-pull" class="vote-count">0</div>
          </div>
          <div class="col-6">
              <h2 style="color: #2ed573;">DO NOTHING</h2>
              <div id="score-wait" class="vote-count">0</div>
          </div>
        </div>

        <div id="host-controls" style="margin-top: 30px;">
             <button id="btn-reveal" class="btn btn-warning" onclick="socket.emit('endRound')">Reveal Results</button>
             <button id="btn-next" class="btn btn-primary" style="display:none;" onclick="socket.emit('nextQuestion')">Next Problem</button>
        </div>
      </div>
    </div>

    <div id="view-player" class="screen">
      <div class="main-content">
        <h2 id="player-status">Waiting...</h2>
        
        <div id="voting-buttons" class="mobile-btn-container" style="display:none;">
          <button class="paper-btn btn-pull big-action-btn" onclick="vote('pull')">
              PULL LEVER ðŸ’€
          </button>
          <button class="paper-btn btn-wait big-action-btn" onclick="vote('wait')">
              DO NOTHING ðŸ˜‡
          </button>
        </div>
      </div>
    </div>

  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let myRole = 'spectator';

    // --- ACTIONS ---
    function joinGame() {
      const name = document.getElementById('username').value || 'Guest';
      socket.emit('joinGame', name);
      myRole = 'player';
      switchView('view-player');
    }

    function becomeHost() {
      myRole = 'host';
      switchView('view-host');
      socket.emit('requestQrCode');
    }

    function updateSettings() {
        const vibe = document.getElementById('setting-vibe').value;
        const mode = document.getElementById('setting-mode').value;
        socket.emit('updateSettings', { vibe, mode });
    }

    function vote(choice) {
      if(myRole === 'player') {
        socket.emit('vote', choice);
        document.getElementById('voting-buttons').style.display = 'none';
        document.getElementById('player-status').innerText = choice === 'pull' ? "You Pulled!" : "You Waited.";
      }
    }

    // --- UPDATES ---
    socket.on('qrCodeData', (url) => { if(myRole==='host') document.getElementById('qr-code-img').src = url; });

    socket.on('updateState', (state) => {
      // HOST: Update Lobby List
      if(myRole === 'host') {
          document.getElementById('player-list').innerHTML = state.players.map(p => `<li>${p.name}</li>`).join('');
          document.getElementById('setting-vibe').value = state.settings.vibe;
          document.getElementById('setting-mode').value = state.settings.mode;
      }

      // HOST: Update Scores
      document.getElementById('score-pull').innerText = state.votes.pull;
      document.getElementById('score-wait').innerText = state.votes.wait;

      // HOST: Question Text
      if(state.currentQuestion) {
          document.getElementById('question-text').innerText = state.currentQuestion.text;
      }

      // PHASE MANAGEMENT
      if (state.phase === 'lobby') {
        showHostSection('host-lobby');
        if(myRole === 'player') {
            document.getElementById('player-status').innerText = "Host is choosing settings...";
            document.getElementById('voting-buttons').style.display = 'none';
        }
      } 
      else if (state.phase === 'voting') {
        showHostSection('host-game');
        document.getElementById('btn-reveal').style.display = 'inline-block';
        document.getElementById('btn-next').style.display = 'none';
        
        if (myRole === 'player') {
            // Only show buttons if they haven't voted yet (this logic is basic, resets on render)
            // For a robust app, we'd check if player.id is in a 'voted' list.
            // For now, we just show them.
            document.getElementById('player-status').innerText = "What do you do?";
            document.getElementById('voting-buttons').style.display = 'flex';
        }
      }
      else if (state.phase === 'results') {
        showHostSection('host-game');
        document.getElementById('btn-reveal').style.display = 'none';
        document.getElementById('btn-next').style.display = 'inline-block';

        if (myRole === 'player') {
            document.getElementById('player-status').innerText = "Results on TV!";
            document.getElementById('voting-buttons').style.display = 'none';
        }
      }
    });

    function switchView(id) {
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function showHostSection(id) {
        if(myRole !== 'host') return;
        document.getElementById('host-lobby').style.display = 'none';
        document.getElementById('host-game').style.display = 'none';
        document.getElementById(id).style.display = 'flex'; // flex for centering
    }
  </script>
</body>
</html>